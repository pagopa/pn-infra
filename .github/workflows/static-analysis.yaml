name: static-analysis
description: |
  This workflow runs static analysis on the infrastructure code using Trivy in IaC mode.
  It scans for vulnerabilities in the runtime infrastructure code.
  - For develop/main: uploads to Security tab and prevents merge if HIGH/CRITICAL vulnerabilities found
  - For other branches: shows inline annotations in PRs only
  - Runs on every push and periodically scans develop and main branches
permissions:
  contents: read
  security-events: write
  pull-requests: write
on:
  push:
  pull_request:
  schedule:
    # Run daily at 2 AM UTC on develop and main branches
    - cron: '0 2 * * *'
jobs:
  build:
    name: Infrastructure Static Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      # For develop/main: generate SARIF for Security tab
      - name: Run Trivy (SARIF) for develop/main (runtime-infra)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results-runtime-infra.sarif'
          skip-files: 'runtime-infra/fragments/vpc.yaml'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy (SARIF) for develop/main (runtime-infra-confinfo)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra-confinfo'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results-runtime-infra-confinfo.sarif'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'CRITICAL,HIGH'

      # For other branches: generate table format for PR annotations
      - name: Run Trivy (JSON) for feature branches (runtime-infra)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra'
          hide-progress: false
          format: 'json'
          output: 'trivy-results-runtime-infra.json'
          skip-files: 'runtime-infra/fragments/vpc.yaml'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy (JSON) for feature branches (runtime-infra-confinfo)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra-confinfo'
          hide-progress: false
          format: 'json'
          output: 'trivy-results-runtime-infra-confinfo.json'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'CRITICAL,HIGH'

      - name: Display vulnerabilities for feature branches (runtime-infra)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        run: |
          if [ -f trivy-results-runtime-infra.json ]; then
            echo "## Runtime-infra vulnerabilities"
            jq -r '.Results[]? | select(.Misconfigurations != null) | .Target as $target | .Misconfigurations[] | "- [\(.Severity)] \($target): \(.ID) - \(.Title)"' trivy-results-runtime-infra.json || echo "No vulnerabilities found"
          fi

      - name: Display vulnerabilities for feature branches (runtime-infra-confinfo)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        run: |
          if [ -f trivy-results-runtime-infra-confinfo.json ]; then
            echo "## Runtime-infra-confinfo vulnerabilities"
            jq -r '.Results[]? | select(.Misconfigurations != null) | .Target as $target | .Misconfigurations[] | "- [\(.Severity)] \($target): \(.ID) - \(.Title)"' trivy-results-runtime-infra-confinfo.json || echo "No vulnerabilities found"
          fi

      - name: Count vulnerabilities for feature branches (runtime-infra)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        id: count-feature-runtime-infra
        run: |
          if [ -f trivy-results-runtime-infra.json ]; then
            count=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-results-runtime-infra.json)
          else
            count=0
          fi
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "HIGH/CRITICAL vulnerabilities in runtime-infra: $count"

      - name: Count vulnerabilities for feature branches (runtime-infra-confinfo)
        if: github.ref != 'refs/heads/develop' && github.ref != 'refs/heads/main'
        id: count-feature-runtime-infra-confinfo
        run: |
          if [ -f trivy-results-runtime-infra-confinfo.json ]; then
            count=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH" or .Severity == "CRITICAL")] | length' trivy-results-runtime-infra-confinfo.json)
          else
            count=0
          fi
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "HIGH/CRITICAL vulnerabilities in runtime-infra-confinfo: $count"


      - name: Filter SARIF to exclude MEDIUM and LOW (runtime-infra)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        run: |
          jq '
            .runs |= map(
              .results |= map(select(
                (.message.text | test("Severity: (HIGH|CRITICAL)"))
              ))
            )
          ' trivy-results-runtime-infra.sarif > trivy-results-runtime-infra-highcritical.sarif
      
      - name: Print number of HIGH/CRITICAL vulnerabilities (runtime-infra)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        id: count-runtime-infra
        run: |
          count=$(jq '[.runs[].results[] | select(.message.text | test("Severity: (HIGH|CRITICAL)"))] | length' trivy-results-runtime-infra.sarif)
          echo "Number of HIGH/CRITICAL vulnerabilities (runtime-infra): $count"
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Filter SARIF to exclude MEDIUM and LOW (runtime-infra-confinfo)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        run: |
          jq '
            .runs |= map(
              .results |= map(select(
                (.message.text | test("Severity: (HIGH|CRITICAL)"))
              ))
            )
          ' trivy-results-runtime-infra-confinfo.sarif > trivy-results-runtime-infra-confinfo-highcritical.sarif
      
      - name: Print number of HIGH/CRITICAL vulnerabilities (runtime-infra-confinfo)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        id: count-runtime-infra-confinfo
        run: |
          count=$(jq '[.runs[].results[] | select(.message.text | test("Severity: (HIGH|CRITICAL)"))] | length' trivy-results-runtime-infra-confinfo.sarif)
          echo "Number of HIGH/CRITICAL vulnerabilities (runtime-infra-confinfo): $count"
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Upload Trivy scan results to GitHub Security tab (runtime-infra)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          sarif_file: 'trivy-results-runtime-infra-highcritical.sarif'
          category: 'trivy-runtime-infra'

      - name: Upload Trivy scan results to GitHub Security tab (runtime-infra-confinfo)
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          sarif_file: 'trivy-results-runtime-infra-confinfo-highcritical.sarif'
          category: 'trivy-runtime-infra-confinfo'

      - name: Fail on HIGH/CRITICAL vulnerabilities for develop/main branches
        if: |
          (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main') &&
          (steps.count-runtime-infra.outputs.count != '0' || steps.count-runtime-infra-confinfo.outputs.count != '0')
        run: |
          echo "::error::Found HIGH/CRITICAL vulnerabilities on protected branch ${{ github.ref }}"
          echo "runtime-infra vulnerabilities: ${{ steps.count-runtime-infra.outputs.count }}"
          echo "runtime-infra-confinfo vulnerabilities: ${{ steps.count-runtime-infra-confinfo.outputs.count }}"
          exit 1

      - name: Fail on HIGH/CRITICAL vulnerabilities for PRs to develop/main
        if: |
          github.event_name == 'pull_request' &&
          (github.base_ref == 'develop' || github.base_ref == 'main') &&
          (steps.count-feature-runtime-infra.outputs.count != '0' || steps.count-feature-runtime-infra-confinfo.outputs.count != '0')
        run: |
          echo "::error::Found HIGH/CRITICAL vulnerabilities in PR targeting ${{ github.base_ref }}"
          echo "runtime-infra vulnerabilities: ${{ steps.count-feature-runtime-infra.outputs.count }}"
          echo "runtime-infra-confinfo vulnerabilities: ${{ steps.count-feature-runtime-infra-confinfo.outputs.count }}"
          echo ""
          echo "Please fix these vulnerabilities before merging to ${{ github.base_ref }}"
          exit 1