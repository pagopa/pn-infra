name: static-analysis
description: |
  This workflow runs static analysis on the infrastructure code using Trivy in IaC mode.
  - Uploads SARIF results to GitHub for Code Scanning alerts (Security Tab) only on develop/main pushes.
  - Uploads SARIF results to GitHub for PR annotations on all branches.
  - Fails the check on HIGH/CRITICAL findings when targeting develop/main.
permissions:
  contents: read
  security-events: write # Necessario per la Security Tab
  pull-requests: write # Necessario per le annotazioni/check
on:
  push:
    branches:
      - develop
      - main
  pull_request:
  schedule:
    # Run daily at 2 AM UTC on develop and main branches
    - cron: '0 2 * * *'

jobs:
  trivy_scan:
    name: Infrastructure Static Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Aggiornato all'ultima versione

      # --- Esecuzione Scansioni SARIF (Valido per tutti i branch) ---

      - name: üõ°Ô∏è Run Trivy (SARIF) for runtime-infra
        uses: aquasecurity/trivy-action@master # Aggiornato alla versione master per sicurezza/stabilit√†
        id: trivy-runtime-infra
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results-runtime-infra.sarif'
          skip-files: 'runtime-infra/fragments/vpc.yaml'
          exit-code: '0'
          trivyignores: '.trivyignore'
          # Scansioniamo tutte le severity (LOW, MEDIUM, HIGH, CRITICAL) per le annotazioni PR
          # Le severity non CRITICAL/HIGH saranno filtrate per la Security Tab
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL' 

      - name: üõ°Ô∏è Run Trivy (SARIF) for runtime-infra-confinfo
        uses: aquasecurity/trivy-action@master
        id: trivy-runtime-infra-confinfo
        with:
          scan-type: 'config'
          scan-ref: './runtime-infra-confinfo'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results-runtime-infra-confinfo.sarif'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'

      # --- Filtro e Upload per GitHub Security Tab (Solo su develop/main push) ---

      # La parte di filtro SARIF non √® pi√π necessaria. Quando carichi il SARIF, GitHub ti permette
      # di configurare le regole di Code Scanning per ignorare LOW/MEDIUM.
      # Tuttavia, se preferisci filtrare, il tuo approccio con JQ √® valido. Lo manteniamo per 
      # coerenza con il tuo file originale, concentrandoci solo sui branch principali.

      - name: üîç Filter SARIF to HIGH/CRITICAL (runtime-infra)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' || github.event_name == 'schedule')
        run: |
          jq '
            .runs |= map(
              .results |= map(select(
                (.message.text | test("Severity: (HIGH|CRITICAL)"))
              ))
            )
          ' trivy-results-runtime-infra.sarif > trivy-results-runtime-infra-highcritical.sarif
      
      - name: üîç Filter SARIF to HIGH/CRITICAL (runtime-infra-confinfo)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' || github.event_name == 'schedule')
        run: |
          jq '
            .runs |= map(
              .results |= map(select(
                (.message.text | test("Severity: (HIGH|CRITICAL)"))
              ))
            )
          ' trivy-results-runtime-infra-confinfo.sarif > trivy-results-runtime-infra-confinfo-highcritical.sarif

      - name: ‚¨ÜÔ∏è Upload Trivy results to Security Tab (runtime-infra)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
        uses: github/codeql-action/upload-sarif@v3 # Aggiornato all'ultima versione
        with:
          sarif_file: 'trivy-results-runtime-infra-highcritical.sarif'
          category: 'trivy-runtime-infra'

      - name: ‚¨ÜÔ∏è Upload Trivy results to Security Tab (runtime-infra-confinfo)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-runtime-infra-confinfo-highcritical.sarif'
          category: 'trivy-runtime-infra-confinfo'

      # --- Annotazioni PR (Universali) ---

      - name: üìù Annotate PR with Trivy results (runtime-infra)
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-runtime-infra.sarif'
          category: 'trivy-pr-annotation-runtime-infra'

      - name: üìù Annotate PR with Trivy results (runtime-infra-confinfo)
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-runtime-infra-confinfo.sarif'
          category: 'trivy-pr-annotation-runtime-infra-confinfo'

      # --- Logica di Fallimento Condizionale (Fail on HIGH/CRITICAL) ---

      # Calcoliamo il conteggio totale di HIGH/CRITICAL in un unico step per il check di fail
      - name: üî¢ Count HIGH/CRITICAL vulnerabilities
        id: count_vulnerabilities
        run: |
          count_infra=$(jq '[.runs[].results[] | select(.message.text | test("Severity: (HIGH|CRITICAL)"))] | length' trivy-results-runtime-infra.sarif)
          count_confinfo=$(jq '[.runs[].results[] | select(.message.text | test("Severity: (HIGH|CRITICAL)"))] | length' trivy-results-runtime-infra-confinfo.sarif)
          total_count=$((count_infra + count_confinfo))
          
          echo "Number of HIGH/CRITICAL vulnerabilities (runtime-infra): $count_infra"
          echo "Number of HIGH/CRITICAL vulnerabilities (runtime-infra-confinfo): $count_confinfo"
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
      
      # Fail se √® una PR verso develop/main O se √® un push su develop/main (prevenendo il merge/push)
      - name: ‚ùå Fail on HIGH/CRITICAL vulnerabilities
        if: |
          (github.event_name == 'pull_request' && (github.base_ref == 'develop' || github.base_ref == 'main')) ||
          (github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'))
        run: |
          if [ "${{ steps.count_vulnerabilities.outputs.total_count }}" -ne "0" ]; then
              echo "::error::Found ${{ steps.count_vulnerabilities.outputs.total_count }} HIGH/CRITICAL vulnerabilities on branch ${{ github.ref }} or PR targeting ${{ github.base_ref }}"
              exit 1
          else
              echo "No HIGH/CRITICAL vulnerabilities found. Proceeding."
          fi