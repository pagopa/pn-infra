name: static-analysis
description: |
  This workflow runs static analysis on the infrastructure code using Trivy in IaC mode.
  It scans for vulnerabilities in the runtime infrastructure code and uploads the results to GitHub's Security tab.
on:
  push:
jobs:
  build:
    name: Infrastructure Static Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Run Trivy vulnerability scanner in IaC mode
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5
        with:
          scan-type: 'config'
          input: './runtime-infra ./runtime-infra-confinfo'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          trivyignores: '.trivyignore'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          sarif_file: 'trivy-results.sarif'