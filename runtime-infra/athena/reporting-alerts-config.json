{
  "queries": {
    "radd-cap-coverage-monitoring": {
      "type": "alerts",
      "description": "Monitors RADD CAP coverage vs AAR template consistency - cumulative from 15/12/2025",
      "schedule": "cron(0 * * * ? *)",
      "query": "WITH radd AS (SELECT distinct cap FROM pn_radd_coverage_temp_json_view WHERE p_year = '2025' AND p_month = '12' AND p_day = '15'), interestingShipment AS (SELECT iun, timestamp, details_numberofpages, details_physicaladdress_foreignstate, details_physicaladdress_zip, details_sentattemptmade, details_recindex, If(details_numberofpages = '1','AAR_NOTIFICATION_RADD_ALT',IF(details_sentattemptmade = '0','AAR_NOTIFICATION', 'AAR_NOTIFICATION_OR_NOT')) as aarGuessedType FROM pn_timelines_json_view WHERE category = 'SEND_ANALOG_DOMICILE' AND p_year = '2025' AND p_month = '12' AND p_day > '14'), aar AS (SELECT iun, details_recindex, details_aarTemplateType as aarType FROM pn_timelines_json_view WHERE category = 'AAR_CREATION_REQUEST' AND p_year = '2025' AND p_month > '10'), enrichedShipment AS (SELECT i.*, a.aarType, (cap is not null AND details_physicaladdress_foreignstate = 'ITALIA') AS guessedRadd, aarGuessedType = 'AAR_NOTIFICATION_RADD_ALT' as isRadd FROM interestingShipment i JOIN aar a ON i.iun = a.iun AND i.details_recindex = a.details_recindex LEFT JOIN radd r ON details_physicaladdress_zip = cap WHERE aarGuessedType != 'AAR_NOTIFICATION_OR_NOT'), analyis AS (SELECT (guessedRadd != isRadd) AS coverageError, (aarGuessedType != aarType) as aarTemplateError, * FROM enrichedShipment) SELECT * FROM analyis WHERE aarTemplateError or coverageError",
      "alerts": [
        {
          "name": "radd-coverage-mismatch",
          "threshold": {
            "operator": ">",
            "value": 0
          },
          "csv_export": true
        }
      ],
      "slack": {
        "enabled": true
      }
    }
  }
}